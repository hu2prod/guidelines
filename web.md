# Веб разработка
## Предпосылки
В основном факты
### Скорость загрузки
  * Чем больше суммарный размер всех файлов, тем дольше грузится сайт
  * Чем больше запросов, тем дольше грузится сайт
  * Существует минимальный размер сайта после которого скорость загрузки радикально улучшить сложнее чем до. Это размер 1 пакета данных.
    * Можно считать минимальным пакетом TCP
    * Можно считать минимальным пакетом MTU
      * Ethernet имеет [MTU](https://ru.wikipedia.org/wiki/Maximum_transmission_unit) 1500 байт (RFC 1191) 
  * Максимальная скорость загрузки сайта ограничена следующими пределами, из которых наименьший является узким звеном
    * Скорость клиента (с учётом того, что он качает еще что-то еще.)
      * Является узким местом у мобильных клиентов
    * Скорость сервера (с учётом того, что он раздает многим клиентам.)
      * Обычно не является узким местом
    * Latency от клиента к серверу (обычно одинаково ко всем серверам т.к. основное latency приходится на канал до проводного/оптического провайдера)
      * После уменьшения размера сайта до 1 пакета данных скорость в пакетах в секунду больше не влияет на загрузку сайта
    * [RTT](https://en.wikipedia.org/wiki/Round-trip_delay_time) cwnd
      * Подробнее про cwnd [eng](https://blog.stackpath.com/glossary/cwnd-and-rwnd/) [rus](https://habr.com/company/oleg-bunin/blog/319114/)
      * Пример. Если cwnd=4 пакета отослано и ни у одного не получен ack, то следующие пакеты не будут отосланы.
        * А скорость позволяет и больше пакетов переслать, но теперь ограничением является rtt+cwnd
      * cwnd непостоянен при tcp сессии и медленно увеличивается если все пакеты доходят и резко уменьшается если есть потери пакетов.
      * У cwnd есть начальное значение Initial cwnd
  * Размер [jumbo frame](https://en.wikipedia.org/wiki/Jumbo_frame) < 9000 байт 
  * В основном (99+%) мы не можем заставить пользователя сменить провайдера ради нашей услуги
  * Сайт, который грузится по https с большой вероятностью может загрузиться БЫСТРЕЕ чем по http [подробности](https://habr.com/company/oleg-bunin/blog/319114/)
## Принципы
Не обязательно факты, которые справедливы всегда, но мы принимаем их
  * Наши клиенты используют HTTP 1.1 (и не поддерживают HTTP 2 и SPDY)
  * Мы считаем что у наших клиентов есть gzip, тем более если они на мобильном соединении
  * Мы принимаем следующие константы для всех расчетов
    * Initial cwnd = 10
    * Для проводного клиента
      * RTT = 50 ms (считаем, что это хороший пинг до google, у проводного пользователя будет в среднем такой же)
        * (источник мой текущий провайдер)
    * Для мобильного клиента
      * RTT = 350 ms (пессимистичный для 3G, очень оптимистичный для 2G)
        * [Источник](https://www.evdoinfo.com/content/view/4818/64/)
        * [По разным городам с 2G](https://mybroadband.co.za/vb/showthread.php/173300-2G-EDGE-Network-performance-tests)
          * Может доходить до секунд.
    * Мы считаем что 1 TCP пакет меньше 9000 байт с заголовком и полностью влезает в frame в той сети, которой пользуется пользователь, либо будет получать фрагменты достаточно быстро, по сравнению с другим отдельным TCP пакетом.
  * Все пакеты, которые успевают до отметки в initial cwnd приходят достаточно быстро и почти одновременно, initial cwnd+1 пакет может прийти с существенной задержкой за счет большого RTT.
  * В идеале мы должны успеть передать ВЕСЬ наш сайт за 10 TCP пакетов
    * 10 берется из initial cwnd
    * Мы будем приравнивать 10 TCP пакетов к 10 полным запросам к сайту
    * Суммарный объем данных который можно передать в 10 TCP пакетах мы будем считать равным 90 Кб.
      * Чем больше мы делаем мелких запросов по меньше чем 9000 байт, тем меньше наш итоговый бюджет
  * Не получив html, мы не знаем какие js,css,img нужно качать
  * Мы можем выбрать одно из двух
    * Мы хотим что бы пользователь не перекачивал js и css для каждой страницы
      * Мы не будем вставлять js и css в html
      * В этом случае пользователь будет ждать 2 RTT до полной загрузки сайта
      * Бюджет сайта
        * 90 Кб html
        * 90 Кб на js, css, img
    * У нас одностраничное приложение и/или мы хотим доставить пользователю как можно больше и/или после чего пользователь уйдет и/или нам нужно показать много контента быстоо
      * Мы вставляем js и css в основной html
      * В этом случае пользователь будет ждать 1 RTT до частичной загрузки сайта и 2 RTT до полной
      * Бюджет сайта
        * 90 Кб на html js и css
        * 90 Кб на img и media
  * Вне разницы какой сценарий мы выберем, если мы уместимся в 90 Кб html + js + css, то мы по-любому будем быстрыми как бы мы не настроили наш сервер.
  * Мы можем стараться уместиться в 1 TCP пакет для оптимального минимального отображения страницы
    * Мы этого *не* будем делать без дополнительного обоснования зачем нам нужно настолько быстро загружать сайт.
      * ~~Торт со взбитыми сливками подойдет~~ Не объясняя ничего, но добавив денег в бюджет мы это сделаем и будем поддерживать (продолжая на это тратить деньги заказчика).

  * Нет повода для использования http, "потому что он быстрее" для открытого интернета
